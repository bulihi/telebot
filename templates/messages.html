<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯åˆ—è¡¨ - Telegram Bot</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 20px; text-decoration: none; color: #007bff; }
        .filters { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }
        .message-list { margin-top: 20px; }
        .message-card {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .message-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .user-info { 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #495057;
        }
        .message-actions { 
            display: flex; 
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        .btn-warning { background-color: #ffc107; }
        .btn-danger { background-color: #dc3545; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .message-content { 
            margin-top: 10px;
            word-break: break-word;
            line-height: 1.5;
        }
        .message-footer {
            margin-top: 10px;
            color: #6c757d;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .message-meta {
            display: flex;
            gap: 15px;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        #loadingSpinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 5px 15px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background: white;
            color: #007bff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pagination button:hover:not(:disabled) {
            background: #007bff;
            color: white;
        }
        .pagination button.active {
            background: #007bff;
            color: white;
        }
        .pagination button:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }
        .file-preview {
            max-width: 300px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .file-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #007bff;
            text-decoration: none;
            margin-top: 10px;
        }
        .file-link:hover {
            text-decoration: underline;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ¶ˆæ¯åˆ—è¡¨</h1>
        
        <div class="nav">
            <a href="/">ä»ªè¡¨æ¿</a>
            <a href="/keywords">å…³é”®è¯ç®¡ç†</a>
            <a href="/violations">è¿è§„è®°å½•</a>
            <a href="/messages">æ¶ˆæ¯åˆ—è¡¨</a>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>ç¾¤ç»„ï¼š</label>
                <select id="chatSelect" onchange="loadMessages(1)">
                    <option value="all">æ‰€æœ‰ç¾¤ç»„</option>
                    {{range .Chats}}
                    <option value="{{.ChatID}}">{{.Title}}</option>
                    {{end}}
                </select>
            </div>
            <div class="filter-group">
                <label>æ¶ˆæ¯ç±»å‹ï¼š</label>
                <select id="messageType" onchange="loadMessages(1)">
                    <option value="all">æ‰€æœ‰ç±»å‹</option>
                    <option value="text">æ–‡æœ¬</option>
                    <option value="photo">å›¾ç‰‡</option>
                    <option value="document">æ–‡ä»¶</option>
                    <option value="video">è§†é¢‘</option>
                    <option value="audio">éŸ³é¢‘</option>
                    <option value="voice">è¯­éŸ³</option>
                    <option value="sticker">è´´çº¸</option>
                </select>
            </div>
        </div>

        <div id="loadingSpinner">
            <div class="loading"></div>
            <p>æ­£åœ¨åŠ è½½æ¶ˆæ¯...</p>
        </div>

        <div id="messageList" class="message-list">
            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <div id="pagination" class="pagination">
            <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let currentPage = 1;
        const perPage = 50;

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // å°äº1åˆ†é’Ÿ
                return 'åˆšåˆš';
            } else if (diff < 3600000) { // å°äº1å°æ—¶
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) { // å°äº1å¤©
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else if (date.getFullYear() === now.getFullYear()) { // åŒå¹´
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            } else {
                return date.toLocaleString();
            }
        }

        function muteUser(userId, messageElement) {
            if (!confirm('ç¡®å®šè¦ç¦è¨€è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
            
            fetch('/api/messages/mute/' + userId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ç”¨æˆ·å·²è¢«ç¦è¨€', 'success');
                    messageElement.querySelector('.message-actions').innerHTML = '<span style="color: #dc3545;">å·²ç¦è¨€</span>';
                } else {
                    showNotification('ç¦è¨€å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('æ“ä½œå¤±è´¥: ' + error, 'error');
            });
        }

        function kickUser(userId, messageElement) {
            if (!confirm('ç¡®å®šè¦è¸¢å‡ºè¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
            
            fetch('/api/messages/kick/' + userId, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('ç”¨æˆ·å·²è¢«è¸¢å‡º', 'success');
                    messageElement.querySelector('.message-actions').innerHTML = '<span style="color: #dc3545;">å·²è¸¢å‡º</span>';
                } else {
                    showNotification('è¸¢å‡ºå¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('æ“ä½œå¤±è´¥: ' + error, 'error');
            });
        }

        function createPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ä¸Šä¸€é¡µ';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => loadMessages(currentPage - 1);
            pagination.appendChild(prevButton);

            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // ç¬¬ä¸€é¡µ
                    i === totalPages || // æœ€åä¸€é¡µ
                    (i >= currentPage - 2 && i <= currentPage + 2) // å½“å‰é¡µé™„è¿‘çš„é¡µç 
                ) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.className = i === currentPage ? 'active' : '';
                    pageButton.onclick = () => loadMessages(i);
                    pagination.appendChild(pageButton);
                } else if (
                    i === currentPage - 3 || // å½“å‰é¡µå‰çš„çœç•¥å·
                    i === currentPage + 3 // å½“å‰é¡µåçš„çœç•¥å·
                ) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ä¸‹ä¸€é¡µ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => loadMessages(currentPage + 1);
            pagination.appendChild(nextButton);
        }

        function loadMessages(page = 1) {
            const spinner = document.getElementById('loadingSpinner');
            const messageList = document.getElementById('messageList');
            const chatId = document.getElementById('chatSelect').value;
            const messageType = document.getElementById('messageType').value;
            
            currentPage = page;
            spinner.style.display = 'block';
            messageList.innerHTML = '';

            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                message_type: messageType,
            });
            if (chatId !== 'all') {
                params.append('chat_id', chatId);
            }

            fetch('/api/messages?' + params.toString())
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (!data.success) {
                    showNotification(data.error || 'åŠ è½½æ¶ˆæ¯å¤±è´¥', 'error');
                    return;
                }

                if (data.messages.length === 0) {
                    messageList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <p>æš‚æ— æ¶ˆæ¯è®°å½•</p>
                        </div>
                    `;
                    return;
                }

                data.messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message-card';
                    
                    // å¤„ç†æ–‡ä»¶é¢„è§ˆ
                    let filePreview = '';
                    if (msg.file_path) {
                        if (msg.message_type === 'photo' || msg.message_type === 'sticker') {
                            filePreview = `<img src="${msg.file_path}" class="file-preview" alt="å›¾ç‰‡">`;
                        } else {
                            filePreview = `
                                <a href="${msg.file_path}" target="_blank" class="file-link">
                                    ğŸ“ æŸ¥çœ‹${msg.message_type === 'video' ? 'è§†é¢‘' : 
                                           msg.message_type === 'audio' ? 'éŸ³é¢‘' : 
                                           msg.message_type === 'voice' ? 'è¯­éŸ³' : 'æ–‡ä»¶'}
                                </a>
                            `;
                        }
                    }

                    messageElement.innerHTML = `
                        <div class="message-header">
                            <div class="user-info">
                                <div class="user-avatar">${getInitials(msg.user_name)}</div>
                                <div>
                                    <div>${msg.user_name}</div>
                                    <small style="color: #6c757d;">ID: ${msg.from_user_id}</small>
                                </div>
                            </div>
                            <div class="message-actions">
                                <button class="btn btn-warning" onclick="muteUser(${msg.from_user_id}, this.closest('.message-card'))">
                                    ğŸ”‡ ç¦è¨€ç”¨æˆ·
                                </button>
                                <button class="btn btn-danger" onclick="kickUser(${msg.from_user_id}, this.closest('.message-card'))">
                                    â›” è¸¢å‡ºç”¨æˆ·
                                </button>
                            </div>
                        </div>
                        <div class="message-content">
                            ${msg.message_content || ''}
                            ${filePreview}
                        </div>
                        <div class="message-footer">
                            <div class="message-meta">
                                <span class="meta-item">ğŸ“± ${msg.message_type}</span>
                                <span class="meta-item">ğŸ‘¥ ${msg.chat_title}</span>
                            </div>
                            <div class="meta-item">
                                ğŸ•’ ${formatTimestamp(msg.timestamp)}
                            </div>
                        </div>
                    `;
                    messageList.appendChild(messageElement);
                });

                createPagination(data.page, data.total_pages);
            })
            .catch(error => {
                spinner.style.display = 'none';
                showNotification('åŠ è½½æ¶ˆæ¯å¤±è´¥: ' + error, 'error');
            });
        }

        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ¶ˆæ¯
        window.onload = () => loadMessages(1);
    </script>
</body>
</html> 